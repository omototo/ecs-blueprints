version: 0.2

phases:
  install:
    commands:
      - curl -sSL https://dot.net/v1/dotnet-install.sh | bash /dev/stdin --channel STS 
  pre_build:
    commands:
      - aws ecr get-login-password --region eu-west-1 | docker login --username AWS --password-stdin 240484791744.dkr.ecr.eu-west-1.amazonaws.com
      - # Replace text in files (requires custom solution)
      - COMMIT_HASH=${CODEBUILD_RESOLVED_SOURCE_VERSION:0:7}
      - if [ -z "$COMMIT_HASH" ]; then COMMIT_HASH="latest"; fi
      - IMAGE_TAG=$COMMIT_HASH
      - cp $CODEBUILD_SRC_DIR/*.csproj $FOLDER_PATH
  build:
    commands:
      - # Build the main container
      - docker build -t $REPO_URL $FOLDER_PATH
      - # Build the echo-service container
      - cd echo-service
      - aws codebuild build --project-name echo-service --source-version $CODEBUILD_RESOLVED_SOURCE_VERSION
      - cd ..
  post_build:
    commands:
      - # Push the main container
      - docker tag $REPO_URL $REPO_URL:$IMAGE_TAG
      - docker push $REPO_URL:$IMAGE_TAG
      - # Push the echo-service container
      - docker tag $REPO_URL-echo-service $REPO_URL-echo-service:$IMAGE_TAG
      - docker push $REPO_URL-echo-service:$IMAGE_TAG
      - # Update task definition (requires custom solution)
      - New-Item -ItemType Directory -Path artifacts -Force
      - Copy-Item tmp-ntd.json artifacts\task-definition.json

artifacts:
  files:
    - '**/*'
  base-directory: 'artifacts'
  discard-paths: yes