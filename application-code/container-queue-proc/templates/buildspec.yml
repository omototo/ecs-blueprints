version: 0.2

phases:
  install:
    runtime-versions:
      python: 3.8.3
      docker: 20
  pre_build:
    commands:
      - $REPO_URL_ARR = $env:REPO_URL -split "/"
        $env:REPOSITORY = $REPO_URL_ARR[0]
      - aws ecr get-login-password --region $env:AWS_REGION | docker login --username AWS --password-stdin $env:REPOSITORY
      - # Replace text in files (requires custom solution)
      - $env:COMMIT_HASH = $env:CODEBUILD_RESOLVED_SOURCE_VERSION.substring(0,7)
      - if ($env:COMMIT_HASH -eq $null) { $env:COMMIT_HASH = "latest" }
      - $env:IMAGE_TAG = $env:COMMIT_HASH
  build:
    commands:
      - docker build -t $env:REPO_URL $env:FOLDER_PATH
  post_build:
    commands:
      # - docker push $env:REPO_URL || true #chicken & egg problem : ecr immutable this push will only works one time, but required for first deployment from terraform
      - docker tag $env:REPO_URL $env:REPO_URL:$env:IMAGE_TAG
      - docker push $env:REPO_URL:$env:IMAGE_TAG
      - # Update task definition (requires custom solution)
      - New-Item -ItemType Directory -Path artifacts -Force
      - Copy-Item tmp-ntd.json artifacts\task-definition.json

artifacts:
  files:
    - '**/*'
  base-directory: 'artifacts'
  discard-paths: yes
